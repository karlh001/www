<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="generator" content="Zim 0.75.2">
    <meta name="description" content="Personal website for my programming, computing and finance hobbies"> 
    <meta name="keywords" content="karl, hunter, go, programming, computing, finance, personal, hobby, defiant-fg, defiant"> 
    <meta name="Zim template" content="HGE Bootstrap responsive template" />
    <meta name="template author" content="Hugo Gaibor E.">
    <meta name="Author" content="Karl Hunter">
    <link rel="icon" href="../../../_resources/images/favicon.ico">

    <title>Monday 16 Sep 2024</title>

    <!-- JS Jquery and Bootstrap scripts -->
    <script type='text/javascript' src="https://karlhunter.co.uk/res/js/jquery-3.6.0.min.js" type="text/javascript"></script>
    <script src="https://karlhunter.co.uk/res/js/bootstrap.min.js"></script>

    <!-- Bootstrap core CSS -->
      <link href="https://karlhunter.co.uk/res/css/bootstrap.css" rel="stylesheet" />

    <!-- highlight module
         Syntax highlinting libraries 
         Taken from https://highlightjs.org/ 
         https://github.com/highlightjs/highlight.js
         You can change higlight code box style by choosing a different css style below, 
         all styles were included for ease of customization
      -->
      <link rel="stylesheet" href="https://karlhunter.co.uk/res/highlight/styles/base16/github.min.css">
      <script src="https://karlhunter.co.uk/res/highlight/highlight.min.js"></script>

    <!-- HGE styles and JS functions for this template -->
      <link href="https://karlhunter.co.uk/res/css/hge-bootstrap_common.css" rel="stylesheet">
      <script src="https://karlhunter.co.uk/res/js/hge-bootstrap_common.js"></script>
      <script src="https://karlhunter.co.uk/res/js/hge-bootstrap_multi-page.js"></script>
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-1 justify-content upper-nav-bar">
      <div class="btn-toolbar" role="toolbar" aria-label="Button groups">
        <div class="btn-group mr-2" role="group" aria-label="First group">
          <span class="text-white">
            <img id="toggleSideMenu" class="pt-0 p-0 px-0 btn" src="https://karlhunter.co.uk/res/images/menu.svg" height="22" alt="Menu">
          </span>
        </div>
      </div>
      <div class="btn-toolbar" role="toolbar" aria-label="Button groups">
        <div class="btn-group mr-2" role="group" aria-label="Navigation group">
              <button type="button" class="btn btn-info btn-xs" role="button" onclick="location.href='../09.html'">Prev</button>
  
              <button type="button" class="btn btn-info btn-xs" role="button" onclick="location.href='../../../map.html'">Index</button>

              <button type="button" class="btn btn-info btn-xs" role="button" onclick="location.href='../../Index.html'">Next</button>
        </div>
      </div>
      <div>
        <div class="btn-group mr-2" role="group" aria-label="Fifth group">
          <button class="btn btn-warning btn-xs" id="scrollUp" onclick="scrollToTop();" style="display: none;"><span style="font-weight: 500;">Scroll Up</span></button>
        </div>
        <div class="btn-group mr-2" role="group" aria-label="Fifth group">
          <button class="btn btn-success btn-xs pt-0 p-0 px-0" id="printMe" >
              <img id="printImg"  class="pt-0 p-0 px-1" style="padding:2px;" onclick="window.print();" src="https://karlhunter.co.uk/res/images/printer.svg" alt="Print">
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
          <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar d-print-none" id="sidebarMenuNav" style="padding-top: 40px;">
          <div id="sidebarMenu">
            <ul>
<li><a href="../../../About.html" title="About" class="page">About</a></li>
<li><a href="../../../Buy_Me_Coffee.html" title="Buy Me Coffee" class="page">Buy Me Coffee</a></li>
<li><a href="../../../Computing.html" title="Computing" class="page">Computing</a></li>
<li><a href="../../../Contact.html" title="Contact" class="page">Contact</a></li>
<li><a href="../../../index.html" title="index" class="page">index</a></li>
<li><a href="../../../Journal.html" title="Journal" class="page">Journal</a>
<ul>
<li><a href="../../2022.html" title="2022" class="page">2022</a></li>
<li><a href="../../2023.html" title="2023" class="page">2023</a></li>
<li><a href="../../2024.html" title="2024" class="page">2024</a>
<ul>
<li><a href="../01.html" title="01" class="page">01</a></li>
<li><a href="../02.html" title="02" class="page">02</a></li>
<li><a href="../03.html" title="03" class="page">03</a></li>
<li><a href="../04.html" title="04" class="page">04</a></li>
<li><a href="../05.html" title="05" class="page">05</a></li>
<li><a href="../07.html" title="07" class="page">07</a></li>
<li><a href="../09.html" title="09" class="page">09</a>
<ul>
<li><b>16</b></li>
</ul></li>
</ul></li>
<li><a href="../../Index.html" title="Index" class="page">Index</a></li>
</ul></li>
<li><a href="../../../Money.html" title="Money" class="page">Money</a></li>
<li><a href="../../../Projects.html" title="Projects" class="page">Projects</a></li>
</ul>

          </div>
        </nav>

        <main role="main" class="col-md-9 col-lg-10 ml-sm-auto pt-3 px-4" id="pageContents">
            <noscript>
              <div style="padding: 10px">
                <span style="color:#D48D8D">
                <p>Javascript is not enabled</p>
                <p>Most features won't</p>
                <p>work correctly</p>
                <p>Please enable javascript</p></span>
              </div>
            </noscript>

                <h1>Monday 16 Sep 2024<a name='Monday 16 Sep 2024_1_1' class="offset-anchor"></a></h1>
              
<hr>


                <h2>Convert from ZFS mirror to raidz<a name='Convert from ZFS mirror to raidz_1_2' class="offset-anchor"></a></h2>
              <p>
<img src="./16/storage-870713_640.jpg">
</p>

<p>
Image <a href="https://pixabay.com/photos/storage-storage-medium-hard-drive-870713/" title="copyright" class="https">copyright</a>.
</p>

<p>
I have a 4 TB ZFS mirror pool over two disks. The has become 56% full, but was thinking about futureproofing this set-up. Since using ZFS, I have always done so in a mirror. My storage started with 1 TB x2 disks, then I upgraded to 2 TB, then I upgraded to 4 TB. Due to costs, I did not want to keep doing this upgrade path as the disks sizes increase. I had to consider other options. 
</p>

<p>
Here are my options:
</p>



<ol type="1" start="1">
<li>Upgrade two of the 4 TB hard drives, one-by-one</li>
</ol>

<ol type="1" start="2">
<li>Add two new drives as a new vdev</li>
</ol>

<ol type="1" start="3">
<li>Reconfigure to raidz1</li>
</ol>





<p>
I decided to go with RAIDZ1. I like cost saving / GB capacity by only needing three drives and getting the capacity of two combined, and if I lose two drives it would be annoying but I do have backups. I had previously opted for the mirror vdev when the pool was in a previous PC with limited space and SATA ports. Now I have a large case and a server motherboard with 6 SATA (4x 6.0 Gbps ports) to add more drives; I am happy with this board because I know have 32 GB of ECC RAM goodness. 
</p>



<p>
This is my pool config before upgrade project.
</p>



<p>
Started with:
</p>



<ul>
<li><tt>mirror-0</tt></li>
</ul>

<p>
  <tt>* Hard drive 4 TB</tt>
</p>

<p>
  <tt>* Hard drive 4 TB</tt>
</p>



<p>
Here's how I did the transition:
</p>



<p>
Firstly, I removed one of the hard drives in the mirror vdev. I now have a spare 4 TB hard drive. I formatted it into two partitions, roughly 2 TB each. I also added a WD Red Pro 2 TB hard drive to up the second disk. Therefore, I have two physcial disks acting as three disks.
</p>



<p>
I created a new pool:
</p>



<ul>
<li><tt>raidz1-0</tt></li>
</ul>

<p>
  <tt>* Hard drive 4 TB - part 1</tt>
</p>

<p>
  <tt>* Hard drive 4 TB - part 2</tt>
</p>

<p>
  <tt>* Hard drive 2 TB</tt>
</p>



<p>
Part 1 and 2 are the partitions of the single disk. This would be considered unsafe to use in production, but I am only doing so to move data and I will then replace later.
</p>



<p>
I wanted to retain settings and snapshots so I used -R and --raw (these datasets are encrypted); if you are not using encryption or the dataset is unlocked you can omit the --raw flag.
</p>



<p>
<tt>zfs send -R --raw pool/dataset@[snapshotdate] | zfs recv pool2/dataset</tt>
</p>



<p>
Once completed, I ran a scrub to ensure data integrity. 
</p>



<p>
At this point, I still have all data on one hard drive (on the original pool), and now on the new pool (plus backups elsewhere). I can only tolerate the loss of the 2 TB hard drive, because if I lose the 4 TB hard drive, I will lose both partitions, effectively losing two hard drives in the eyes of ZFS. 
</p>



<p>
I put the original pool offline and cleared the disk, after first verifying sizes of copied datasets. I used this newly-wiped 4 TB hard drive to replace part 2 (the second and final disk in the mirror) of the other 4 TB hard drive. This was the most dangerous stage of the process.
</p>



<p>
The new layout was as follows:
</p>



<pre>
â€¢ raidz1-0

  * Hard drive 4 TB - part 1

  * Hard drive 4 TB

  * Hard drive 2 TB

</pre>




<p>
I am safe now and have redundancy. If either drive fails, I am able to reconstruct the data. But I cannot leave the layout like this. I need to expand the partition of the 4 TB hard drive.
</p>



<p>
Final step was to offline the pool and adjust the partition.
</p>

<p>
I used <tt>fdisk</tt> to delete old partition 1, then create a new one on top which simply expands the partition without deleting data. I
</p>



<p>
After these steps I now had a happy pool again:
</p>



<ul>
<li><tt>raidz1-0</tt></li>
</ul>

<p>
  <tt>* Hard drive 4 TB</tt> 
</p>

<p>
  <tt>* Hard drive 4 TB</tt>
</p>

<p>
  <tt>* Hard drive 2 TB</tt>
</p>



<p>
Total pool size: 5.45 TiB<br>
Percent used: 52%
</p>


<p>
<i>I  since found out that you can add just two disks to a raidz1, which will make the pool degraded but once data is copied, you can then attach the disk you copied data from to then fix the pool; this saves creating a disk with two partitions.</i>
</p>

            
            <span class="backlinks">
                <hr class='footnotes'>
                <b>Backlinks:</b>
                <br />
                <a href='../../../index.html'>index</a>
                
<br />
                <a href='../../Index.html'>Journal:Index</a>
                
<br />
                <a href='../09.html'>Journal:2024:09</a>
                
            </span>

            

        </main>
      </div>
    </div>
  </body>
</html>
